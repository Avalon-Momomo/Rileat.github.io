<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>天气 · Apple 风动态版</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui, sans-serif;
      color: #fff;
      display: flex;
      justify-content: center;
      align-items: stretch;
      padding: 16px;
      background: #050816; /* 备用底色，真正视觉由 canvas 决定 */
      overflow: hidden;
    }

    /* 动态天气背景画布 */
    #weather-bg {
      position: fixed;
      inset: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      display: block;
    }

    .app {
      width: 100%;
      max-width: 960px;
      margin: auto;
      padding: 18px 16px 24px;
      border-radius: 32px;
      background: linear-gradient(145deg, rgba(255,255,255,0.12), rgba(255,255,255,0.03));
      backdrop-filter: blur(22px) saturate(1.2);
      -webkit-backdrop-filter: blur(22px) saturate(1.2);
      border: 1px solid rgba(255,255,255,0.2);
      box-shadow: 0 24px 60px rgba(0,0,0,0.45);
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    header.top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .city-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .city {
      font-size: 26px;
      font-weight: 600;
    }

    .time {
      font-size: 13px;
      opacity: 0.85;
    }

    .search-box {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .search-box input {
      padding: 8px 12px;
      border-radius: 999px;
      border: none;
      outline: none;
      font-size: 14px;
      background: rgba(255,255,255,0.18);
      color: #fff;
      min-width: 150px;
    }
    .search-box button {
      border-radius: 999px;
      border: none;
      padding: 8px 12px;
      font-size: 14px;
      background: rgba(255,255,255,0.22);
      color: #fff;
      font-weight: 500;
      cursor: pointer;
      white-space: nowrap;
    }

    .now {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      margin-top: 4px;
      margin-bottom: 8px;
    }

    .temp {
      font-size: 80px;
      line-height: 1;
      font-weight: 600;
    }

    .condition-main {
      font-size: 18px;
      opacity: 0.9;
    }

    .hi-lo {
      font-size: 14px;
      opacity: 0.9;
    }

    .now-extra {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 4px;
    }

    .now-icon {
      width: 52px;
      height: 52px;
      filter: drop-shadow(0 4px 10px rgba(0,0,0,0.5));
    }

    .feels {
      font-size: 13px;
      opacity: 0.9;
    }

    .section-title {
      font-size: 14px;
      font-weight: 600;
      letter-spacing: .05em;
      text-transform: uppercase;
      opacity: 0.9;
      margin-bottom: 6px;
      padding-left: 4px;
    }

    main {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .hourly-strip {
      display: flex;
      gap: 10px;
      overflow-x: auto;
      padding-bottom: 4px;
      padding-top: 2px;
      scrollbar-width: thin;
    }

    .hourly-strip::-webkit-scrollbar {
      height: 4px;
    }
    .hourly-strip::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,0.35);
      border-radius: 999px;
    }

    .hour-item {
      min-width: 60px;
      padding: 8px 6px;
      border-radius: 18px;
      background: rgba(0,0,0,0.16);
      border: 1px solid rgba(255,255,255,0.18);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      font-size: 12px;
    }

    .hour-item img {
      width: 26px;
      height: 26px;
    }

    .hour-time {
      opacity: 0.8;
    }

    .hour-temp {
      font-size: 14px;
      font-weight: 500;
    }

    .daily-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .day-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 10px;
      border-radius: 18px;
      background: rgba(0,0,0,0.16);
      border: 1px solid rgba(255,255,255,0.18);
      font-size: 13px;
      gap: 8px;
    }

    .day-left {
      flex: 1;
    }

    .day-icon {
      width: 30px;
      height: 30px;
      margin-right: 6px;
      filter: drop-shadow(0 2px 6px rgba(0,0,0,0.4));
    }

    .day-middle {
      display: flex;
      align-items: center;
      gap: 6px;
      flex: 1.2;
    }

    .day-right {
      display: flex;
      justify-content: flex-end;
      gap: 6px;
      font-size: 13px;
      flex: 0.8;
    }

    .temp-max {
      font-weight: 500;
    }
    .temp-min {
      opacity: 0.75;
    }

    @media (max-width: 640px) {
      .day-right {
        flex-direction: column;
        align-items: flex-end;
      }
    }

    .today-grid {
      display: grid;
      grid-template-columns: repeat(3,minmax(0,1fr));
      gap: 8px;
    }

    @media (max-width: 640px) {
      .today-grid {
        grid-template-columns: repeat(2,minmax(0,1fr));
      }
    }

    .card-small {
      padding: 10px 12px;
      border-radius: 16px;
      background: rgba(0,0,0,0.16);
      border: 1px solid rgba(255,255,255,0.18);
      font-size: 13px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .card-small-label {
      opacity: 0.8;
    }

    .card-small-value {
      font-size: 16px;
      font-weight: 500;
    }

    footer {
      margin-top: 6px;
      font-size: 11px;
      opacity: 0.8;
      display: flex;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }

    footer span {
      white-space: nowrap;
    }
  </style>
</head>
<body>

<canvas id="weather-bg"></canvas>

<div class="app">
  <header class="top">
    <div class="city-block">
      <div class="city" id="city">加载中...</div>
      <div class="time" id="localtime">—</div>
    </div>

    <div class="search-box">
      <input id="search" placeholder="输入城市，例如 Sydney">
      <button id="searchBtn">搜索</button>
      <button id="locBtn">定位</button>
    </div>
  </header>

  <main>
    <!-- 当前 -->
    <section class="now">
      <div class="temp" id="temp">--°</div>
      <div class="condition-main" id="condition">正在获取天气...</div>
      <div class="hi-lo" id="hiLo">最高 --° · 最低 --°</div>

      <div class="now-extra">
        <img id="icon" class="now-icon" src="" alt="">
        <div class="feels" id="feelsLike">体感：--°</div>
      </div>
    </section>

    <!-- 小时预报 -->
    <section>
      <div class="section-title">小时预报</div>
      <div class="hourly-strip" id="hourlyStrip">
        <!-- JS 填充 -->
      </div>
    </section>

    <!-- 未来几天 -->
    <section>
      <div class="section-title">未来几天</div>
      <div class="daily-list" id="dailyList">
        <!-- JS 填充 -->
      </div>
    </section>

    <!-- 今日详情卡片 -->
    <section>
      <div class="section-title">今日详情</div>
      <div class="today-grid">
        <div class="card-small">
          <div class="card-small-label">风速</div>
          <div class="card-small-value" id="wind">-- km/h</div>
        </div>
        <div class="card-small">
          <div class="card-small-label">湿度</div>
          <div class="card-small-value" id="humidity">--%</div>
        </div>
        <div class="card-small">
          <div class="card-small-label">紫外线指数</div>
          <div class="card-small-value" id="uv">--</div>
        </div>
        <div class="card-small">
          <div class="card-small-label">气压</div>
          <div class="card-small-value" id="pressure">-- hPa</div>
        </div>
        <div class="card-small">
          <div class="card-small-label">能见度</div>
          <div class="card-small-value" id="visibility">-- km</div>
        </div>
        <div class="card-small">
          <div class="card-small-label">云量</div>
          <div class="card-small-value" id="cloud">--%</div>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <span>数据来源：WeatherAPI</span>
    <span id="updated">上次更新：—</span>
  </footer>
</div>

<script>
  /* ================== 动态天气背景（画布） ================== */
  const canvas = document.getElementById("weather-bg");
  const ctx = canvas.getContext("2d");

  function resizeCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
  }
  window.addEventListener("resize", resizeCanvas);
  resizeCanvas();

  let rainDrops = [];
  let snowFlakes = [];
  let stars = [];
  let foregroundClouds = [];
  let backgroundClouds = [];

  let weatherMode = "sun";         // sun / cloud / rain / storm / snow / night
  let timeOfDay = "day";           // day / evening / night / dawn
  let windX = 0;

  let targetSky = { top: "#57A8FF", bottom: "#CBE7FF" };
  let currentSky = { top: "#57A8FF", bottom: "#CBE7FF" };

  const skyPresets = {
    sun_day:   { top: "#57A8FF", bottom: "#CBE7FF" },
    sun_even:  { top: "#FF9A62", bottom: "#FFCF96" },
    sun_dawn:  { top: "#FF8BA7", bottom: "#FCD5CE" },
    cloud:     { top: "#7D8FA3", bottom: "#C6D0DD" },
    rain:      { top: "#4B5666", bottom: "#767F8A" },
    storm:     { top: "#3B404C", bottom: "#5A6470" },
    snow:      { top: "#90C2FF", bottom: "#E1F0FF" },
    night:     { top: "#050816", bottom: "#090F2A" }
  };

  function createRain(intensity = 1) {
    rainDrops = [];
    const base = 400 * (window.innerWidth / 800);
    const count = Math.floor(base * intensity);
    for (let i=0;i<count;i++) {
      rainDrops.push({
        x: Math.random()*canvas.width,
        y: Math.random()*canvas.height,
        len: 8 + Math.random()*10,
        speedY: 8 + Math.random()*7,
        speedX: windX + (Math.random()-0.5)*0.8
      });
    }
  }

  function createSnow(intensity = 1) {
    snowFlakes = [];
    const base = 160 * (window.innerWidth / 800);
    const count = Math.floor(base * intensity);
    for (let i=0;i<count;i++) {
      snowFlakes.push({
        x: Math.random()*canvas.width,
        y: Math.random()*canvas.height,
        r: 1.5 + Math.random()*2.5,
        speedY: 1 + Math.random()*1.5,
        offset: Math.random()*Math.PI*2
      });
    }
  }

  function createStars() {
    stars = [];
    const count = 140;
    for (let i=0;i<count;i++) {
      stars.push({
        x: Math.random()*canvas.width,
        y: Math.random()*canvas.height*0.6,
        r: Math.random()*1.2 + 0.4,
        alpha: Math.random(),
        speed: Math.random()*0.015 + 0.005
      });
    }
  }

  function createCloudLayer() {
    foregroundClouds = [];
    backgroundClouds = [];
    const fgCount = 6;
    const bgCount = 5;

    for (let i=0;i<fgCount;i++) {
      foregroundClouds.push({
        x: Math.random()*canvas.width,
        y: canvas.height*0.25 + Math.random()*canvas.height*0.25,
        w: 220 + Math.random()*160,
        h: 60 + Math.random()*30,
        speed: 0.22 + Math.random()*0.15
      });
    }

    for (let i=0;i<bgCount;i++) {
      backgroundClouds.push({
        x: Math.random()*canvas.width,
        y: canvas.height*0.12 + Math.random()*canvas.height*0.18,
        w: 260 + Math.random()*200,
        h: 70 + Math.random()*30,
        speed: 0.08 + Math.random()*0.10
      });
    }
  }

  function drawCloud(x,y,w,h,alpha) {
    ctx.save();
    ctx.fillStyle = "rgba(255,255,255,"+alpha+")";
    ctx.beginPath();
    ctx.ellipse(x, y, w*0.45, h*0.5, 0, 0, Math.PI*2);
    ctx.ellipse(x-w*0.25, y+5, w*0.3, h*0.4, 0, 0, Math.PI*2);
    ctx.ellipse(x+w*0.25, y+8, w*0.3, h*0.4, 0, 0, Math.PI*2);
    ctx.fill();
    ctx.restore();
  }

  function drawSunOrMoon(type) {
    const cx = canvas.width * 0.18;
    const cy = canvas.height * 0.22;

    const gradient = ctx.createRadialGradient(cx, cy, 0, cx, cy, 110);
    if (type === "sun") {
      gradient.addColorStop(0, "rgba(255,255,255,0.95)");
      gradient.addColorStop(0.4, "rgba(255,255,200,0.85)");
      gradient.addColorStop(1, "rgba(255,255,200,0)");
    } else {
      gradient.addColorStop(0, "rgba(255,255,255,0.95)");
      gradient.addColorStop(0.4, "rgba(200,220,255,0.8)");
      gradient.addColorStop(1, "rgba(200,220,255,0)");
    }

    ctx.fillStyle = gradient;
    ctx.beginPath();
    ctx.arc(cx, cy, 110, 0, Math.PI*2);
    ctx.fill();

    ctx.fillStyle = type === "sun"
      ? "rgba(255,255,255,0.96)"
      : "rgba(230,240,255,0.96)";
    ctx.beginPath();
    ctx.arc(cx, cy, 28, 0, Math.PI*2);
    ctx.fill();
  }

  function lerpColor(c1, c2, t) {
    const a = hexToRgb(c1), b = hexToRgb(c2);
    const r = Math.round(a.r + (b.r-a.r)*t);
    const g = Math.round(a.g + (b.g-a.g)*t);
    const b2 = Math.round(a.b + (b.b-a.b)*t);
    return `rgb(${r},${g},${b2})`;
  }

  function hexToRgb(c) {
    if (c.startsWith("rgb")) {
      const m = c.match(/\d+/g);
      return { r:+m[0], g:+m[1], b:+m[2] };
    }
    let hex = c.replace("#","");
    if (hex.length===3) hex = hex.split("").map(x=>x+x).join("");
    const num = parseInt(hex,16);
    return { r:(num>>16)&255, g:(num>>8)&255, b:num&255 };
  }

  let lastTime = 0;
  function animate(t) {
    requestAnimationFrame(animate);
    const dt = (t - lastTime)/16.67 || 1;
    lastTime = t;

    const lerp = 0.03;
    currentSky.top = lerpColor(currentSky.top, targetSky.top, lerp);
    currentSky.bottom = lerpColor(currentSky.bottom, targetSky.bottom, lerp);

    const g = ctx.createLinearGradient(0,0,0,canvas.height);
    g.addColorStop(0, currentSky.top);
    g.addColorStop(1, currentSky.bottom);
    ctx.fillStyle = g;
    ctx.fillRect(0,0,canvas.width,canvas.height);

    if (weatherMode === "night") {
      stars.forEach(s => {
        s.alpha += s.speed * (Math.random()<0.5?-1:1);
        if (s.alpha < 0.2) s.alpha = 0.2;
        if (s.alpha > 1) s.alpha = 1;
        ctx.fillStyle = `rgba(255,255,255,${s.alpha})`;
        ctx.beginPath();
        ctx.arc(s.x, s.y, s.r, 0, Math.PI*2);
        ctx.fill();
      });
    }

    if (weatherMode !== "night") {
      drawSunOrMoon("sun");
    } else {
      drawSunOrMoon("moon");
    }

    if (["sun","cloud","rain","storm","snow"].includes(weatherMode)) {
      backgroundClouds.forEach(c => {
        c.x += c.speed * dt;
        if (c.x - c.w > canvas.width) c.x = -c.w;
        drawCloud(c.x, c.y, c.w, c.h, 0.18);
      });

      foregroundClouds.forEach(c => {
        c.x += c.speed * dt;
        if (c.x - c.w > canvas.width) c.x = -c.w;
        drawCloud(c.x, c.y, c.w, c.h, 0.26);
      });
    }

    if (weatherMode === "rain" || weatherMode === "storm") {
      ctx.strokeStyle = "rgba(255,255,255,0.45)";
      ctx.lineWidth = 1.1;
      rainDrops.forEach(d => {
        ctx.beginPath();
        ctx.moveTo(d.x, d.y);
        ctx.lineTo(d.x + d.speedX*1.1, d.y + d.len);
        ctx.stroke();

        d.x += d.speedX * dt;
        d.y += d.speedY * dt;

        if (d.y > canvas.height + 20) {
          d.y = -20;
          d.x = Math.random()*canvas.width;
        }
      });

      if (weatherMode === "storm" && Math.random() < 0.004) {
        ctx.fillStyle = "rgba(255,255,255,0.2)";
        ctx.fillRect(0,0,canvas.width,canvas.height);
      }
    }

    if (weatherMode === "snow") {
      ctx.fillStyle = "rgba(255,255,255,0.96)";
      snowFlakes.forEach(f => {
        f.y += f.speedY * dt;
        f.x += Math.sin(f.offset + t*0.0015) * 0.5 * dt;
        if (f.y > canvas.height+10) {
          f.y = -10;
          f.x = Math.random()*canvas.width;
        }
        ctx.beginPath();
        ctx.arc(f.x, f.y, f.r, 0, Math.PI*2);
        ctx.fill();
      });
    }
  }
  requestAnimationFrame(animate);

  function setWeatherVisual(conditionText, localtimeStr, isDayFlag) {
    const text = (conditionText || "").toLowerCase();

    let hour = null;
    if (localtimeStr) {
      const m = localtimeStr.match(/\d{4}-\d{2}-\d{2} (\d{2})/);
      if (m) hour = parseInt(m[1],10);
    }
    if (hour !== null) {
      if (hour >= 20 || hour < 5) timeOfDay = "night";
      else if (hour >= 17) timeOfDay = "evening";
      else if (hour < 8)  timeOfDay = "dawn";
      else               timeOfDay = "day";
    } else {
      timeOfDay = isDayFlag ? "day" : "night";
    }

    if (/thunder|storm|雷/.test(text)) {
      weatherMode = "storm";
      targetSky = skyPresets.storm;
      windX = 2.5;
      createRain(1.3);
      createCloudLayer();
    } else if (/rain|drizzle|阵雨|雨/.test(text)) {
      weatherMode = "rain";
      targetSky = skyPresets.rain;
      windX = 1.5;
      createRain(1.0);
      createCloudLayer();
    } else if (/snow|sleet|雪/.test(text)) {
      weatherMode = "snow";
      targetSky = skyPresets.snow;
      windX = 0.3;
      createSnow(1.0);
      createCloudLayer();
    } else if (/cloud|overcast|多云|阴/.test(text)) {
      weatherMode = "cloud";
      targetSky = skyPresets.cloud;
      windX = 0.6;
      createCloudLayer();
      rainDrops = [];
      snowFlakes = [];
      stars = [];
    } else if (timeOfDay === "night") {
      weatherMode = "night";
      targetSky = skyPresets.night;
      windX = 0.1;
      createStars();
      createCloudLayer();
      rainDrops = [];
      snowFlakes = [];
    } else {
      weatherMode = "sun";
      if (timeOfDay === "evening")      targetSky = skyPresets.sun_even;
      else if (timeOfDay === "dawn")    targetSky = skyPresets.sun_dawn;
      else                              targetSky = skyPresets.sun_day;
      windX = 0.4;
      rainDrops = [];
      snowFlakes = [];
      createCloudLayer();
      stars = [];
    }
  }

  /* ================== WeatherAPI + UI ================== */

  const API_KEY = "0871934c91a1479984b40316250912";

  const cityEl       = document.getElementById("city");
  const timeEl       = document.getElementById("localtime");
  const tempEl       = document.getElementById("temp");
  const condEl       = document.getElementById("condition");
  const hiLoEl       = document.getElementById("hiLo");
  const iconEl       = document.getElementById("icon");
  const feelsEl      = document.getElementById("feelsLike");
  const windEl       = document.getElementById("wind");
  const humidityEl   = document.getElementById("humidity");
  const uvEl         = document.getElementById("uv");
  const pressureEl   = document.getElementById("pressure");
  const visEl        = document.getElementById("visibility");
  const cloudEl      = document.getElementById("cloud");
  const updatedEl    = document.getElementById("updated");

  const hourlyStrip  = document.getElementById("hourlyStrip");
  const dailyList    = document.getElementById("dailyList");

  const searchInput  = document.getElementById("search");
  const searchBtn    = document.getElementById("searchBtn");
  const locBtn       = document.getElementById("locBtn");

  searchBtn.addEventListener("click", () => {
    const val = searchInput.value.trim();
    if (!val) return;
    fetchWeatherByQuery(val);
  });

  searchInput.addEventListener("keydown", e => {
    if (e.key === "Enter") searchBtn.click();
  });

  locBtn.addEventListener("click", autoLocate);

  async function fetchWeatherByQuery(q) {
    try {
      const url = `https://api.weatherapi.com/v1/forecast.json?key=${API_KEY}&q=${encodeURIComponent(q)}&days=5&aqi=no&alerts=no`;
      const res = await fetch(url);
      const data = await res.json();
      if (data.error) throw new Error(data.error.message);
      updateUI(data);
    } catch (e) {
      alert("获取天气失败，请检查城市名后重试");
      console.error(e);
    }
  }

  function updateUI(data) {
    const loc = data.location;
    const c   = data.current;
    const forecast = data.forecast?.forecastday || [];

    cityEl.textContent = `${loc.name}, ${loc.region || loc.country}`;
    timeEl.textContent = `当地时间：${loc.localtime}`;
    tempEl.textContent = `${Math.round(c.temp_c)}°`;
    condEl.textContent = c.condition.text;
    iconEl.src = "https:" + c.condition.icon;
    iconEl.alt = c.condition.text;

    // 有 forecast 就用当天的 max/min
    if (forecast[0]) {
      const day = forecast[0].day;
      hiLoEl.textContent = `最高 ${Math.round(day.maxtemp_c)}° · 最低 ${Math.round(day.mintemp_c)}°`;
    } else {
      const hi = Math.round(c.temp_c + 2);
      const lo = Math.round(c.temp_c - 2);
      hiLoEl.textContent = `最高 ${hi}° · 最低 ${lo}°`;
    }

    feelsEl.textContent    = `体感：${Math.round(c.feelslike_c)}°`;
    windEl.textContent     = `${c.wind_kph} km/h`;
    humidityEl.textContent = `${c.humidity}%`;
    uvEl.textContent       = `${c.uv}`;
    pressureEl.textContent = c.pressure_mb ? `${c.pressure_mb} hPa` : "—";
    visEl.textContent      = c.vis_km !== undefined ? `${c.vis_km} km` : "—";
    cloudEl.textContent    = c.cloud !== undefined ? `${c.cloud}%` : "—";

    const now = new Date();
    updatedEl.textContent = `上次更新：${now.toLocaleTimeString()}`;

    // 小时预报
    renderHourly(forecast[0], loc.localtime);

    // 日预报
    renderDaily(forecast, loc.localtime);

    // 动态背景
    setWeatherVisual(c.condition.text, loc.localtime, c.is_day === 1);
  }

  function renderHourly(dayData, localtimeStr) {
    hourlyStrip.innerHTML = "";
    if (!dayData) return;
    const hours = dayData.hour || [];

    let currentHour = 0;
    const m = localtimeStr && localtimeStr.match(/\d{4}-\d{2}-\d{2} (\d{2})/);
    if (m) currentHour = parseInt(m[1],10);

    const items = [];

    // 取从当前小时开始的后 12 小时（可能跨天，这里只用当天的，简单一点）
    for (let i = 0; i < hours.length; i++) {
      const h = hours[i];
      const hm = h.time.match(/\d{4}-\d{2}-\d{2} (\d{2}):/);
      if (!hm) continue;
      const hour = parseInt(hm[1],10);
      if (hour >= currentHour && items.length < 12) {
        items.push(h);
      }
    }
    // 如果当天不足 12 个小时，就补前面的
    for (let i = 0; i < hours.length && items.length < 12; i++) {
      const h = hours[i];
      if (!items.includes(h)) items.push(h);
    }

    items.forEach((h, index) => {
      const hm = h.time.match(/\d{4}-\d{2}-\d{2} (\d{2}):/);
      let label = "--";
      if (hm) {
        const hour = parseInt(hm[1],10);
        if (index === 0) label = "现在";
        else label = `${hour}时`;
      }
      const div = document.createElement("div");
      div.className = "hour-item";
      div.innerHTML = `
        <div class="hour-time">${label}</div>
        <img src="https:${h.condition.icon}" alt="${h.condition.text}">
        <div class="hour-temp">${Math.round(h.temp_c)}°</div>
      `;
      hourlyStrip.appendChild(div);
    });
  }

  function renderDaily(forecastArr, localtimeStr) {
    dailyList.innerHTML = "";
    if (!forecastArr || !forecastArr.length) return;

    const todayDate = localtimeStr?.split(" ")[0];

    forecastArr.forEach((d, idx) => {
      const dateStr = d.date;
      const label = getDayLabel(dateStr, idx, todayDate);
      const day = d.day;
      const row = document.createElement("div");
      row.className = "day-row";
      row.innerHTML = `
        <div class="day-left">${label}</div>
        <div class="day-middle">
          <img class="day-icon" src="https:${day.condition.icon}" alt="${day.condition.text}">
          <span>${day.condition.text}</span>
        </div>
        <div class="day-right">
          <span class="temp-max">${Math.round(day.maxtemp_c)}°</span>
          <span class="temp-min">${Math.round(day.mintemp_c)}°</span>
        </div>
      `;
      dailyList.appendChild(row);
    });
  }

  function getDayLabel(dateStr, index, todayStr) {
    if (dateStr === todayStr) return "今天";
    if (index === 1 && todayStr) return "明天";

    const d = new Date(dateStr);
    const names = ["周日","周一","周二","周三","周四","周五","周六"];
    return names[d.getDay()];
  }

  function autoLocate() {
    if (!navigator.geolocation) {
      fetchWeatherByQuery("Sydney");
      return;
    }
    navigator.geolocation.getCurrentPosition(
      pos => {
        const q = `${pos.coords.latitude},${pos.coords.longitude}`;
        fetchWeatherByQuery(q);
      },
      err => {
        console.warn("定位失败，使用默认城市", err);
        fetchWeatherByQuery("Sydney");
      }
    );
  }

  // 初始加载
  autoLocate();
</script>

</body>
</html>
