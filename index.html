<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>天气 · Apple 风动态版</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui, sans-serif;
      color: #fff;
      display: flex;
      justify-content: center;
      align-items: stretch;
      padding: 16px;
      background: #050816; /* 真实背景交给 canvas，这里只是兜底色 */
      overflow: hidden;
    }

    /* 动态天气背景画布 */
    #weather-bg {
      position: fixed;
      inset: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      display: block;
    }

    .app {
      width: 100%;
      max-width: 960px;
      margin: auto;
      padding: 18px 16px 24px;
      border-radius: 32px;
      background: linear-gradient(145deg, rgba(255,255,255,0.12), rgba(255,255,255,0.03));
      backdrop-filter: blur(22px) saturate(1.2);
      -webkit-backdrop-filter: blur(22px) saturate(1.2);
      border: 1px solid rgba(255,255,255,0.2);
      box-shadow: 0 24px 60px rgba(0,0,0,0.45);
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    header.top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .city-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .city {
      font-size: 26px;
      font-weight: 600;
    }

    .time {
      font-size: 13px;
      opacity: 0.85;
    }

    .search-box {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .search-box input {
      padding: 8px 12px;
      border-radius: 999px;
      border: none;
      outline: none;
      font-size: 14px;
      background: rgba(255,255,255,0.18);
      color: #fff;
      min-width: 150px;
    }
    .search-box button {
      border-radius: 999px;
      border: none;
      padding: 8px 12px;
      font-size: 14px;
      background: rgba(255,255,255,0.22);
      color: #fff;
      font-weight: 500;
      cursor: pointer;
      white-space: nowrap;
    }

    .now {
      display: grid;
      grid-template-columns: minmax(0,1.3fr) minmax(0,1fr);
      gap: 8px;
      align-items: center;
    }

    @media (max-width: 640px) {
      .now {
        grid-template-columns: 1fr;
        row-gap: 12px;
      }
    }

    .temp {
      font-size: 72px;
      line-height: 1;
      font-weight: 600;
    }

    .temp-block {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .condition-main {
      font-size: 18px;
      opacity: 0.9;
    }

    .hi-lo {
      font-size: 14px;
      opacity: 0.9;
    }

    .right-now {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 6px;
    }

    .now-icon {
      width: 60px;
      height: 60px;
      filter: drop-shadow(0 4px 10px rgba(0,0,0,0.5));
    }

    .feels {
      font-size: 13px;
      opacity: 0.9;
    }

    .section-title {
      font-size: 14px;
      font-weight: 600;
      letter-spacing: .05em;
      text-transform: uppercase;
      opacity: 0.9;
      margin-bottom: 4px;
    }

    .today-grid {
      display: grid;
      grid-template-columns: repeat(3,minmax(0,1fr));
      gap: 8px;
    }

    @media (max-width: 640px) {
      .today-grid {
        grid-template-columns: repeat(2,minmax(0,1fr));
      }
    }

    .card-small {
      padding: 10px 12px;
      border-radius: 16px;
      background: rgba(0,0,0,0.16);
      border: 1px solid rgba(255,255,255,0.18);
      font-size: 13px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .card-small-label {
      opacity: 0.8;
    }

    .card-small-value {
      font-size: 16px;
      font-weight: 500;
    }

    footer {
      margin-top: 4px;
      font-size: 11px;
      opacity: 0.8;
      display: flex;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }

    footer span {
      white-space: nowrap;
    }
  </style>
</head>
<body>

<canvas id="weather-bg"></canvas>

<div class="app">
  <header class="top">
    <div class="city-block">
      <div class="city" id="city">加载中...</div>
      <div class="time" id="localtime">—</div>
    </div>

    <div class="search-box">
      <input id="search" placeholder="输入城市，例如 中国上海 / Rhodes NSW / rhodes 2138">
      <button id="searchBtn">搜索</button>
      <button id="locBtn">定位</button>
    </div>
  </header>

  <main>
    <section class="now">
      <div class="temp-block">
        <div class="temp" id="temp">--°</div>
        <div class="condition-main" id="condition">正在获取天气...</div>
        <div class="hi-lo" id="hiLo">最高 --° · 最低 --°</div>
      </div>

      <div class="right-now">
        <img id="icon" class="now-icon" src="" alt="">
        <div class="feels" id="feelsLike">体感：--°</div>
      </div>
    </section>

    <section>
      <div class="section-title">今日详情</div>
      <div class="today-grid">
        <div class="card-small">
          <div class="card-small-label">风速</div>
          <div class="card-small-value" id="wind">-- km/h</div>
        </div>
        <div class="card-small">
          <div class="card-small-label">湿度</div>
          <div class="card-small-value" id="humidity">--%</div>
        </div>
        <div class="card-small">
          <div class="card-small-label">紫外线指数</div>
          <div class="card-small-value" id="uv">--</div>
        </div>
        <div class="card-small">
          <div class="card-small-label">气压</div>
          <div class="card-small-value" id="pressure">-- hPa</div>
        </div>
        <div class="card-small">
          <div class="card-small-label">能见度</div>
          <div class="card-small-value" id="visibility">-- km</div>
        </div>
        <div class="card-small">
          <div class="card-small-label">云量</div>
          <div class="card-small-value" id="cloud">--%</div>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <span>数据来源：WeatherAPI</span>
    <span id="updated">上次更新：—</span>
  </footer>
</div>

<script>
  /* ================== 动态天气背景（画布） ================== */
  var canvas = document.getElementById("weather-bg");
  var ctx = canvas.getContext("2d");

  function resizeCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
  }
  window.addEventListener("resize", resizeCanvas);
  resizeCanvas();

  // 粒子容器
  var rainDrops = [];
  var snowFlakes = [];
  var stars = [];
  var foregroundClouds = [];
  var backgroundClouds = [];

  var weatherMode = "sun";   // sun / cloud / rain / storm / snow / night
  var timeOfDay = "day";     // day / evening / night / dawn
  var windX = 0;

  var targetSky = { top: "#57A8FF", bottom: "#CBE7FF" };
  var currentSky = { top: "#57A8FF", bottom: "#CBE7FF" };

  var skyPresets = {
    sun_day:   { top: "#57A8FF", bottom: "#CBE7FF" },
    sun_even:  { top: "#FF9A62", bottom: "#FFCF96" },
    sun_dawn:  { top: "#FF8BA7", bottom: "#FCD5CE" },
    cloud:     { top: "#7D8FA3", bottom: "#C6D0DD" },
    rain:      { top: "#4B5666", bottom: "#767F8A" },
    storm:     { top: "#3B404C", bottom: "#5A6470" },
    snow:      { top: "#90C2FF", bottom: "#E1F0FF" },
    night:     { top: "#050816", bottom: "#090F2A" }
  };

  function createRain(intensity) {
    if (intensity === undefined) intensity = 1;
    rainDrops = [];
    var base = 400 * (window.innerWidth / 800);
    var count = Math.floor(base * intensity);
    for (var i = 0; i < count; i++) {
      rainDrops.push({
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height,
        len: 8 + Math.random() * 10,
        speedY: 8 + Math.random() * 7,
        speedX: windX + (Math.random() - 0.5) * 0.8
      });
    }
  }

  function createSnow(intensity) {
    if (intensity === undefined) intensity = 1;
    snowFlakes = [];
    var base = 160 * (window.innerWidth / 800);
    var count = Math.floor(base * intensity);
    for (var i = 0; i < count; i++) {
      snowFlakes.push({
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height,
        r: 1.5 + Math.random() * 2.5,
        speedY: 1 + Math.random() * 1.5,
        offset: Math.random() * Math.PI * 2
      });
    }
  }

  function createStars() {
    stars = [];
    var count = 140;
    for (var i = 0; i < count; i++) {
      stars.push({
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height * 0.6,
        r: Math.random() * 1.2 + 0.4,
        alpha: Math.random(),
        speed: Math.random() * 0.015 + 0.005
      });
    }
  }

  function createCloudLayer() {
    foregroundClouds = [];
    backgroundClouds = [];
    var fgCount = 6;
    var bgCount = 5;

    for (var i = 0; i < fgCount; i++) {
      foregroundClouds.push({
        x: Math.random() * canvas.width,
        y: canvas.height * 0.25 + Math.random() * canvas.height * 0.25,
        w: 220 + Math.random() * 160,
        h: 60 + Math.random() * 30,
        speed: 0.22 + Math.random() * 0.15
      });
    }

    for (var j = 0; j < bgCount; j++) {
      backgroundClouds.push({
        x: Math.random() * canvas.width,
        y: canvas.height * 0.12 + Math.random() * canvas.height * 0.18,
        w: 260 + Math.random() * 200,
        h: 70 + Math.random() * 30,
        speed: 0.08 + Math.random() * 0.10
      });
    }
  }

  function drawCloud(x, y, w, h, alpha) {
    ctx.save();
    ctx.fillStyle = "rgba(255,255,255," + alpha + ")";
    ctx.beginPath();
    ctx.ellipse(x, y, w * 0.45, h * 0.5, 0, 0, Math.PI * 2);
    ctx.ellipse(x - w * 0.25, y + 5, w * 0.3, h * 0.4, 0, 0, Math.PI * 2);
    ctx.ellipse(x + w * 0.25, y + 8, w * 0.3, h * 0.4, 0, 0, Math.PI * 2);
    ctx.fill();
    ctx.restore();
  }

  function drawSunOrMoon(type) {
    var cx = canvas.width * 0.18;
    var cy = canvas.height * 0.22;

    var gradient = ctx.createRadialGradient(cx, cy, 0, cx, cy, 100);
    if (type === "sun") {
      gradient.addColorStop(0, "rgba(255,255,255,0.95)");
      gradient.addColorStop(0.4, "rgba(255,255,200,0.85)");
      gradient.addColorStop(1, "rgba(255,255,200,0)");
    } else {
      gradient.addColorStop(0, "rgba(255,255,255,0.95)");
      gradient.addColorStop(0.4, "rgba(200,220,255,0.8)");
      gradient.addColorStop(1, "rgba(200,220,255,0)");
    }

    ctx.fillStyle = gradient;
    ctx.beginPath();
    ctx.arc(cx, cy, 100, 0, Math.PI * 2);
    ctx.fill();

    ctx.fillStyle = (type === "sun")
      ? "rgba(255,255,255,0.96)"
      : "rgba(230,240,255,0.96)";
    ctx.beginPath();
    ctx.arc(cx, cy, 28, 0, Math.PI * 2);
    ctx.fill();
  }

  function lerpColor(c1, c2, t) {
    var a = hexToRgb(c1);
    var b = hexToRgb(c2);
    var r = Math.round(a.r + (b.r - a.r) * t);
    var g = Math.round(a.g + (b.g - a.g) * t);
    var b2 = Math.round(a.b + (b.b - a.b) * t);
    return "rgb(" + r + "," + g + "," + b2 + ")";
  }

  function hexToRgb(c) {
    if (c.indexOf("rgb") === 0) {
      var m = c.match(/\d+/g);
      return { r: +m[0], g: +m[1], b: +m[2] };
    }
    var hex = c.replace("#", "");
    if (hex.length === 3) {
      hex = hex.charAt(0) + hex.charAt(0) +
            hex.charAt(1) + hex.charAt(1) +
            hex.charAt(2) + hex.charAt(2);
    }
    var num = parseInt(hex, 16);
    return { r: (num >> 16) & 255, g: (num >> 8) & 255, b: num & 255 };
  }

  var lastTime = 0;
  function animate(t) {
    requestAnimationFrame(animate);
    var dt = (t - lastTime) / 16.67;
    if (!dt) dt = 1;
    lastTime = t;

    var lerp = 0.03;
    currentSky.top = lerpColor(currentSky.top, targetSky.top, lerp);
    currentSky.bottom = lerpColor(currentSky.bottom, targetSky.bottom, lerp);

    var g = ctx.createLinearGradient(0, 0, 0, canvas.height);
    g.addColorStop(0, currentSky.top);
    g.addColorStop(1, currentSky.bottom);
    ctx.fillStyle = g;
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // 夜晚星星
    if (weatherMode === "night") {
      for (var i = 0; i < stars.length; i++) {
        var s = stars[i];
        s.alpha += s.speed * (Math.random() < 0.5 ? -1 : 1);
        if (s.alpha < 0.2) s.alpha = 0.2;
        if (s.alpha > 1) s.alpha = 1;
        ctx.fillStyle = "rgba(255,255,255," + s.alpha + ")";
        ctx.beginPath();
        ctx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
        ctx.fill();
      }
    }

    // 太阳 / 月亮
    if (weatherMode !== "night") {
      drawSunOrMoon("sun");
    } else {
      drawSunOrMoon("moon");
    }

    // 云层
    if (["sun","cloud","rain","storm","snow"].indexOf(weatherMode) !== -1) {
      for (var j = 0; j < backgroundClouds.length; j++) {
        var cb = backgroundClouds[j];
        cb.x += cb.speed * dt;
        if (cb.x - cb.w > canvas.width) cb.x = -cb.w;
        drawCloud(cb.x, cb.y, cb.w, cb.h, 0.18);
      }

      for (var k = 0; k < foregroundClouds.length; k++) {
        var cf = foregroundClouds[k];
        cf.x += cf.speed * dt;
        if (cf.x - cf.w > canvas.width) cf.x = -cf.w;
        drawCloud(cf.x, cf.y, cf.w, cf.h, 0.26);
      }
    }

    // 雨
    if (weatherMode === "rain" || weatherMode === "storm") {
      ctx.strokeStyle = "rgba(255,255,255,0.45)";
      ctx.lineWidth = 1.2;
      for (var m = 0; m < rainDrops.length; m++) {
        var d = rainDrops[m];
        ctx.beginPath();
        ctx.moveTo(d.x, d.y);
        ctx.lineTo(d.x + d.speedX * 1.2, d.y + d.len);
        ctx.stroke();

        d.x += d.speedX * dt;
        d.y += d.speedY * dt;

        if (d.y > canvas.height + 20) {
          d.y = -20;
          d.x = Math.random() * canvas.width;
        }
      }

      if (weatherMode === "storm" && Math.random() < 0.004) {
        ctx.fillStyle = "rgba(255,255,255,0.2)";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
      }
    }

    // 雪
    if (weatherMode === "snow") {
      ctx.fillStyle = "rgba(255,255,255,0.96)";
      for (var n = 0; n < snowFlakes.length; n++) {
        var f = snowFlakes[n];
        f.y += f.speedY * dt;
        f.x += Math.sin(f.offset + t * 0.0015) * 0.5 * dt;
        if (f.y > canvas.height + 10) {
          f.y = -10;
          f.x = Math.random() * canvas.width;
        }
        ctx.beginPath();
        ctx.arc(f.x, f.y, f.r, 0, Math.PI * 2);
        ctx.fill();
      }
    }
  }
  requestAnimationFrame(animate);

  function setWeatherVisual(conditionText, localtimeStr, isDayFlag) {
    var text = "";
    if (conditionText) text = conditionText.toLowerCase();

    var hour = null;
    if (localtimeStr) {
      var m = localtimeStr.match(/\d{4}-\d{2}-\d{2} (\d{2})/);
      if (m) hour = parseInt(m[1], 10);
    }

    if (hour !== null) {
      if (hour >= 20 || hour < 5)       timeOfDay = "night";
      else if (hour >= 17)              timeOfDay = "evening";
      else if (hour < 8)                timeOfDay = "dawn";
      else                              timeOfDay = "day";
    } else {
      timeOfDay = isDayFlag ? "day" : "night";
    }

    if (/thunder|storm|雷/.test(text)) {
      weatherMode = "storm";
      targetSky = skyPresets.storm;
      windX = 2.5;
      createRain(1.3);
      createCloudLayer();
    } else if (/rain|drizzle|阵雨|雨/.test(text)) {
      weatherMode = "rain";
      targetSky = skyPresets.rain;
      windX = 1.5;
      createRain(1.0);
      createCloudLayer();
    } else if (/snow|sleet|雪/.test(text)) {
      weatherMode = "snow";
      targetSky = skyPresets.snow;
      windX = 0.3;
      createSnow(1.0);
      createCloudLayer();
    } else if (/cloud|overcast|多云|阴/.test(text)) {
      weatherMode = "cloud";
      targetSky = skyPresets.cloud;
      windX = 0.6;
      createCloudLayer();
      rainDrops = [];
      snowFlakes = [];
      stars = [];
    } else if (timeOfDay === "night") {
      weatherMode = "night";
      targetSky = skyPresets.night;
      windX = 0.1;
      createStars();
      createCloudLayer();
      rainDrops = [];
      snowFlakes = [];
    } else {
      weatherMode = "sun";
      if (timeOfDay === "evening")      targetSky = skyPresets.sun_even;
      else if (timeOfDay === "dawn")    targetSky = skyPresets.sun_dawn;
      else                              targetSky = skyPresets.sun_day;
      windX = 0.4;
      rainDrops = [];
      snowFlakes = [];
      createCloudLayer();
      stars = [];
    }
  }

  /* ================== WeatherAPI + 苹果 UI ================== */

  var API_KEY = "0871934c91a1479984b40316250912";

  var cityEl     = document.getElementById("city");
  var timeEl     = document.getElementById("localtime");
  var tempEl     = document.getElementById("temp");
  var condEl     = document.getElementById("condition");
  var hiLoEl     = document.getElementById("hiLo");
  var iconEl     = document.getElementById("icon");
  var feelsEl    = document.getElementById("feelsLike");
  var windEl     = document.getElementById("wind");
  var humidityEl = document.getElementById("humidity");
  var uvEl       = document.getElementById("uv");
  var pressureEl = document.getElementById("pressure");
  var visEl      = document.getElementById("visibility");
  var cloudEl    = document.getElementById("cloud");
  var updatedEl  = document.getElementById("updated");

  var searchInput = document.getElementById("search");
  var searchBtn   = document.getElementById("searchBtn");
  var locBtn      = document.getElementById("locBtn");

  searchBtn.addEventListener("click", function () {
    var val = searchInput.value.trim();
    if (!val) return;
    fetchWeatherByQuery(val);
  });

  searchInput.addEventListener("keydown", function (e) {
    if (e.key === "Enter") {
      searchBtn.click();
    }
  });

  locBtn.addEventListener("click", autoLocate);

  function fetchWeatherByQuery(q) {
    var url = "https://api.weatherapi.com/v1/current.json?key=" +
              API_KEY + "&q=" + encodeURIComponent(q) + "&aqi=no";
    fetch(url)
      .then(function (res) { return res.json(); })
      .then(function (data) {
        if (data.error) {
          throw new Error(data.error.message || "API Error");
        }
        updateUI(data);
      })
      .catch(function (e) {
        alert("获取天气失败，请检查城市名或网络连接");
        console.error(e);
      });
  }

  function updateUI(data) {
    var loc = data.location;
    var c   = data.current;

    cityEl.textContent = loc.name + ", " + (loc.region || loc.country);
    timeEl.textContent = "当地时间：" + loc.localtime;
    tempEl.textContent = Math.round(c.temp_c) + "°";
    condEl.textContent = c.condition.text;
    iconEl.src = "https:" + c.condition.icon;
    iconEl.alt = c.condition.text;

    var hi = Math.round(c.temp_c + 2);
    var lo = Math.round(c.temp_c - 2);
    hiLoEl.textContent = "最高 " + hi + "° · 最低 " + lo + "°";

    feelsEl.textContent    = "体感：" + Math.round(c.feelslike_c) + "°";
    windEl.textContent     = c.wind_kph + " km/h";
    humidityEl.textContent = c.humidity + "%";
    uvEl.textContent       = c.uv;
    pressureEl.textContent = c.pressure_mb ? (c.pressure_mb + " hPa") : "—";
    visEl.textContent      = (c.vis_km !== undefined) ? (c.vis_km + " km") : "—";
    cloudEl.textContent    = (c.cloud !== undefined) ? (c.cloud + "%") : "—";

    var now = new Date();
    updatedEl.textContent = "上次更新：" + now.toLocaleTimeString();

    // 动态背景效果
    setWeatherVisual(c.condition.text, loc.localtime, c.is_day === 1);
  }

  function autoLocate() {
    if (!navigator.geolocation) {
      fetchWeatherByQuery("Sydney");
      return;
    }
    navigator.geolocation.getCurrentPosition(
      function (pos) {
        var q = pos.coords.latitude + "," + pos.coords.longitude;
        fetchWeatherByQuery(q);
      },
      function (err) {
        console.warn("定位失败，使用默认城市", err);
        fetchWeatherByQuery("Sydney");
      }
    );
  }

  // 初始加载：尝试定位
  autoLocate();
</script>

</body>
</html>
