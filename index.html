<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>天气 · Apple 风精简版</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui, sans-serif;
      color: #fff;
      display: flex;
      justify-content: center;
      align-items: stretch;
      padding: 16px;
      background: #050816; /* 背景主色，真实动态效果交给 canvas */
      overflow-y: auto;
      overflow-x: hidden;
    }

    /* 动态天气背景画布 */
    #weather-bg {
      position: fixed;
      inset: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      display: block;
    }

    /* —— 默认（桌面为主）样式 —— */
    .app {
      width: 100%;
      max-width: 420px;           /* 中间一小块卡片 */
      margin: 72px auto;          /* 上下留白，居中 */
      padding: 22px 20px 20px;
      border-radius: 32px;
      background: linear-gradient(145deg, rgba(255,255,255,0.14), rgba(255,255,255,0.06));
      backdrop-filter: blur(22px) saturate(1.2);
      -webkit-backdrop-filter: blur(22px) saturate(1.2);
      border: 1px solid rgba(255,255,255,0.18);
      box-shadow:
        0 22px 55px rgba(0,0,0,0.45),
        inset 0 0 18px rgba(255,255,255,0.18);
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    /* 顶部：城市 + 搜索框（都在卡片内） */
    header.top {
      display: grid;
      grid-template-columns: 1.2fr 1fr;
      align-items: center;
      gap: 12px;
    }

    .city-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .city {
      font-size: 26px;
      font-weight: 600;
    }

    .time {
      font-size: 13px;
      opacity: 0.85;
    }

    .search-box {
      justify-self: end;
      display: flex;
      gap: 8px;
      align-items: center;
      position: relative;
      transition: transform .15s ease;
    }

    .search-box:focus-within {
      transform: translateY(-1px);
    }

    .search-box input {
      padding: 8px 12px;
      border-radius: 999px;
      border: none;
      outline: none;
      font-size: 14px;
      background: rgba(255,255,255,0.18);
      color: #fff;
      width: 170px;
      transition: background .18s ease, box-shadow .18s ease, transform .12s ease;
    }

    .search-box input::placeholder {
      color: rgba(255,255,255,0.7);
    }

    .search-box input:focus {
      background: rgba(255,255,255,0.26);
      box-shadow:
        0 0 0 1px rgba(255,255,255,0.9),
        0 0 18px rgba(0,0,0,0.7);
      transform: translateY(-1px);
    }

    .search-box button {
      border-radius: 999px;
      border: none;
      padding: 8px 12px;
      font-size: 14px;
      background: rgba(255,255,255,0.22);
      color: #fff;
      font-weight: 500;
      cursor: pointer;
      white-space: nowrap;
      transition: transform .08s ease, background .15s ease;
    }

    .search-box button:active {
      transform: scale(.97);
      background: rgba(255,255,255,0.3);
    }

    .now {
      display: grid;
      grid-template-columns: minmax(0,1.3fr) minmax(0,1fr);
      gap: 8px;
      align-items: center;
      margin-top: 4px;
    }

    .temp {
      font-size: 72px;
      line-height: 1;
      font-weight: 600;
    }

    .temp-block {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .condition-main {
      font-size: 18px;
      opacity: 0.9;
    }

    .hi-lo {
      font-size: 14px;
      opacity: 0.9;
    }

    .right-now {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 6px;
    }

    .now-icon {
      width: 60px;
      height: 60px;
      filter: drop-shadow(0 4px 10px rgba(0,0,0,0.5));
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .now-icon svg {
      width: 100%;
      height: 100%;
    }

    .feels {
      font-size: 13px;
      opacity: 0.9;
    }

    footer {
      margin-top: 4px;
      font-size: 11px;
      opacity: 0.85;
      display: flex;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }

    footer span {
      white-space: nowrap;
    }

    /* —— 手机端美化：只在 <= 640px 生效，不影响桌面 —— */
    @media (max-width: 640px) {
      body {
        padding: 8px;
      }

      .app {
        max-width: none;
        width: calc(100% - 24px);  /* 稍微贴边一点，像 App */
        margin: 12px auto 16px;
        padding: 18px 16px 18px;
        border-radius: 26px;
        gap: 16px;
      }

      header.top {
        grid-template-columns: 1fr;
        row-gap: 10px;
      }

      .search-box {
        justify-self: stretch;
        flex-direction: column;
        width: 100%;
        align-items: stretch;
      }

      .search-box input {
        width: 100%;
        min-width: 0;
        padding-block: 9px;
      }

      .search-box button {
        width: 100%;
        padding-block: 9px;
      }

      .now {
        grid-template-columns: 1fr;
        row-gap: 10px;
        text-align: center;
      }

      .temp-block {
        align-items: center;
      }

      .temp {
        font-size: 64px;
      }

      .right-now {
        align-items: center;
      }

      .now-icon {
        width: 56px;
        height: 56px;
      }

      footer {
        flex-direction: column;
        align-items: flex-start;
        gap: 2px;
      }
    }
  </style>
</head>
<body>

<canvas id="weather-bg"></canvas>

<div class="app">
  <header class="top">
    <div class="city-block">
      <div class="city" id="city">加载中...</div>
      <div class="time" id="localtime">—</div>
    </div>

    <div class="search-box">
      <input id="search" placeholder="输入城市，例如 中国上海 / Rhodes NSW / rhodes 2138">
      <button id="searchBtn">搜索</button>
      <button id="locBtn">定位</button>
    </div>
  </header>

  <main>
    <section class="now">
      <div class="temp-block">
        <div class="temp" id="temp">--°</div>
        <div class="condition-main" id="condition">正在获取天气...</div>
        <div class="hi-lo" id="hiLo">最高 --° · 最低 --°</div>
      </div>

      <div class="right-now">
        <div id="iconWrapper" class="now-icon"></div>
        <div class="feels" id="feelsLike">体感：--°</div>
      </div>
    </section>
  </main>

  <footer>
    <span>数据来源：WeatherAPI</span>
    <span id="updated">上次更新：—</span>
  </footer>
</div>

<script>
  /* ================== 动态天气背景（画布） ================== */
  var canvas = document.getElementById("weather-bg");
  var ctx = canvas.getContext("2d");

  function resizeCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
  }
  window.addEventListener("resize", resizeCanvas);
  resizeCanvas();

  var rainDrops = [];
  var snowFlakes = [];
  var stars = [];
  var foregroundClouds = [];
  var backgroundClouds = [];

  var weatherMode = "sun"; // sun / cloud / rain / storm / snow / night
  var timeOfDay = "day";   // day / evening / night / dawn
  var windX = 0;

  var targetSky = { top: "#57A8FF", bottom: "#CBE7FF" };
  var currentSky = { top: "#57A8FF", bottom: "#CBE7FF" };

  var skyPresets = {
    sun_day:   { top: "#57A8FF", bottom: "#CBE7FF" },
    sun_even:  { top: "#FF9A62", bottom: "#FFCF96" },
    sun_dawn:  { top: "#FF8BA7", bottom: "#FCD5CE" },
    cloud:     { top: "#7D8FA3", bottom: "#C6D0DD" },
    rain:      { top: "#4B5666", bottom: "#767F8A" },
    storm:     { top: "#3B404C", bottom: "#5A6470" },
    snow:      { top: "#90C2FF", bottom: "#E1F0FF" },
    night:     { top: "#050816", bottom: "#090F2A" }
  };

  function createRain(intensity) {
    if (intensity === undefined) intensity = 1;
    rainDrops = [];
    var base = 400 * (window.innerWidth / 800);
    var count = Math.floor(base * intensity);
    for (var i = 0; i < count; i++) {
      rainDrops.push({
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height,
        len: 8 + Math.random() * 10,
        speedY: 8 + Math.random() * 7,
        speedX: windX + (Math.random() - 0.5) * 0.8
      });
    }
  }

  function createSnow(intensity) {
    if (intensity === undefined) intensity = 1;
    snowFlakes = [];
    var base = 160 * (window.innerWidth / 800);
    var count = Math.floor(base * intensity);
    for (var i = 0; i < count; i++) {
      snowFlakes.push({
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height,
        r: 1.5 + Math.random() * 2.5,
        speedY: 1 + Math.random() * 1.5,
        offset: Math.random() * Math.PI * 2
      });
    }
  }

  function createStars() {
    stars = [];
    var count = 140;
    for (var i = 0; i < count; i++) {
      stars.push({
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height * 0.6,
        r: Math.random() * 1.2 + 0.4,
        alpha: Math.random(),
        speed: Math.random() * 0.015 + 0.005
      });
    }
  }

  function createCloudLayer() {
    foregroundClouds = [];
    backgroundClouds = [];
    var fgCount = 6;
    var bgCount = 5;

    for (var i = 0; i < fgCount; i++) {
      foregroundClouds.push({
        x: Math.random() * canvas.width,
        y: canvas.height * 0.25 + Math.random() * canvas.height * 0.25,
        w: 220 + Math.random() * 160,
        h: 60 + Math.random() * 30,
        speed: 0.22 + Math.random() * 0.15
      });
    }

    for (var j = 0; j < bgCount; j++) {
      backgroundClouds.push({
        x: Math.random() * canvas.width,
        y: canvas.height * 0.12 + Math.random() * canvas.height * 0.18,
        w: 260 + Math.random() * 200,
        h: 70 + Math.random() * 30,
        speed: 0.08 + Math.random() * 0.10
      });
    }
  }

  function drawCloud(x, y, w, h, alpha) {
    ctx.save();
    ctx.fillStyle = "rgba(255,255,255," + alpha + ")";
    ctx.beginPath();
    ctx.ellipse(x, y, w * 0.45, h * 0.5, 0, 0, Math.PI * 2);
    ctx.ellipse(x - w * 0.25, y + 5, w * 0.3, h * 0.4, 0, 0, Math.PI * 2);
    ctx.ellipse(x + w * 0.25, y + 8, w * 0.3, h * 0.4, 0, 0, Math.PI * 2);
    ctx.fill();
    ctx.restore();
  }

  function drawSunOrMoon(type) {
    var cx = canvas.width * 0.18;
    var cy = canvas.height * 0.22;

    var gradient = ctx.createRadialGradient(cx, cy, 0, cx, cy, 100);
    if (type === "sun") {
      gradient.addColorStop(0, "rgba(255,255,255,0.95)");
      gradient.addColorStop(0.4, "rgba(255,255,200,0.85)");
      gradient.addColorStop(1, "rgba(255,255,200,0)");
    } else {
      gradient.addColorStop(0, "rgba(255,255,255,0.95)");
      gradient.addColorStop(0.4, "rgba(200,220,255,0.8)");
      gradient.addColorStop(1, "rgba(200,220,255,0)");
    }

    ctx.fillStyle = gradient;
    ctx.beginPath();
    ctx.arc(cx, cy, 100, 0, Math.PI * 2);
    ctx.fill();

    ctx.fillStyle = (type === "sun")
      ? "rgba(255,255,255,0.96)"
      : "rgba(230,240,255,0.96)";
    ctx.beginPath();
    ctx.arc(cx, cy, 28, 0, Math.PI * 2);
    ctx.fill();
  }

  function hexToRgb(c) {
    if (c.indexOf("rgb") === 0) {
      var m = c.match(/\d+/g);
      return { r: +m[0], g: +m[1], b: +m[2] };
    }
    var hex = c.replace("#", "");
    if (hex.length === 3) {
      hex =
        hex.charAt(0) + hex.charAt(0) +
        hex.charAt(1) + hex.charAt(1) +
        hex.charAt(2) + hex.charAt(2);
    }
    var num = parseInt(hex, 16);
    return { r: (num >> 16) & 255, g: (num >> 8) & 255, b: num & 255 };
  }

  function lerpColor(c1, c2, t) {
    var a = hexToRgb(c1);
    var b = hexToRgb(c2);
    var r = Math.round(a.r + (b.r - a.r) * t);
    var g = Math.round(a.g + (b.g - a.g) * t);
    var b2 = Math.round(a.b + (b.b - a.b) * t);
    return "rgb(" + r + "," + g + "," + b2 + ")";
  }

  function drawGroundGlow() {
    // 底部环境光晕，让光照更柔和
    var gx = canvas.width * 0.5;
    var gy = canvas.height * 0.9;
    var grad = ctx.createRadialGradient(gx, gy, 0, gx, gy, canvas.height * 0.7);

    var color;
    if (weatherMode === "sun") {
      color = "rgba(255,255,255,0.18)";
    } else if (weatherMode === "rain" || weatherMode === "storm") {
      color = "rgba(200,220,255,0.12)";
    } else if (weatherMode === "snow") {
      color = "rgba(255,255,255,0.22)";
    } else if (weatherMode === "night") {
      color = "rgba(120,160,255,0.12)";
    } else { // cloud
      color = "rgba(230,235,245,0.14)";
    }

    grad.addColorStop(0, color);
    grad.addColorStop(1, "rgba(0,0,0,0)");
    ctx.fillStyle = grad;
    ctx.fillRect(0, 0, canvas.width, canvas.height);
  }

  var lastTime = 0;
  function animate(t) {
    requestAnimationFrame(animate);
    var dt = (t - lastTime) / 16.67;
    if (!dt) dt = 1;
    lastTime = t;

    // 天空颜色缓动更丝滑
    var lerp = 0.02;
    currentSky.top = lerpColor(currentSky.top, targetSky.top, lerp);
    currentSky.bottom = lerpColor(currentSky.bottom, targetSky.bottom, lerp);

    var g = ctx.createLinearGradient(0, 0, 0, canvas.height);
    g.addColorStop(0, currentSky.top);
    g.addColorStop(1, currentSky.bottom);
    ctx.fillStyle = g;
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // 环境光晕
    drawGroundGlow();

    // 星星（夜晚）
    if (weatherMode === "night") {
      for (var i = 0; i < stars.length; i++) {
        var s = stars[i];
        s.alpha += s.speed * (Math.random() < 0.5 ? -1 : 1);
        if (s.alpha < 0.2) s.alpha = 0.2;
        if (s.alpha > 1) s.alpha = 1;
        ctx.fillStyle = "rgba(255,255,255," + s.alpha + ")";
        ctx.beginPath();
        ctx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
        ctx.fill();
      }
    }

    // 太阳 / 月亮
    if (weatherMode !== "night") {
      drawSunOrMoon("sun");
    } else {
      drawSunOrMoon("moon");
    }

    // 云层
    if (["sun", "cloud", "rain", "storm", "snow"].indexOf(weatherMode) !== -1) {
      for (var j = 0; j < backgroundClouds.length; j++) {
        var cb = backgroundClouds[j];
        cb.x += cb.speed * dt;
        if (cb.x - cb.w > canvas.width) cb.x = -cb.w;
        drawCloud(cb.x, cb.y, cb.w, cb.h, 0.18);
      }

      for (var k = 0; k < foregroundClouds.length; k++) {
        var cf = foregroundClouds[k];
        cf.x += cf.speed * dt;
        if (cf.x - cf.w > canvas.width) cf.x = -cf.w;
        drawCloud(cf.x, cf.y, cf.w, cf.h, 0.26);
      }
    }

    // 雨
    if (weatherMode === "rain" || weatherMode === "storm") {
      ctx.strokeStyle = "rgba(255,255,255,0.45)";
      ctx.lineWidth = 1.2;
      for (var m = 0; m < rainDrops.length; m++) {
        var d = rainDrops[m];
        ctx.beginPath();
        ctx.moveTo(d.x, d.y);
        ctx.lineTo(d.x + d.speedX * 1.2, d.y + d.len);
        ctx.stroke();

        d.x += d.speedX * dt;
        d.y += d.speedY * dt;

        if (d.y > canvas.height + 20) {
          d.y = -20;
          d.x = Math.random() * canvas.width;
        }
      }

      // 闪电
      if (weatherMode === "storm" && Math.random() < 0.004) {
        ctx.fillStyle = "rgba(255,255,255,0.2)";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
      }
    }

    // 雪
    if (weatherMode === "snow") {
      ctx.fillStyle = "rgba(255,255,255,0.96)";
      for (var n = 0; n < snowFlakes.length; n++) {
        var f = snowFlakes[n];
        f.y += f.speedY * dt;
        f.x += Math.sin(f.offset + t * 0.0015) * 0.5 * dt;
        if (f.y > canvas.height + 10) {
          f.y = -10;
          f.x = Math.random() * canvas.width;
        }
        ctx.beginPath();
        ctx.arc(f.x, f.y, f.r, 0, Math.PI * 2);
        ctx.fill();
      }
    }
  }
  requestAnimationFrame(animate);

  function setWeatherVisual(conditionText, localtimeStr, isDayFlag) {
    var text = "";
    if (conditionText) {
      text = conditionText.toLowerCase();
    }

    var hour = null;
    if (localtimeStr) {
      var m = localtimeStr.match(/\d{4}-\d{2}-\d{2} (\d{2})/);
      if (m) {
        hour = parseInt(m[1], 10);
      }
    }

    if (hour !== null) {
      if (hour >= 20 || hour < 5) {
        timeOfDay = "night";
      } else if (hour >= 17) {
        timeOfDay = "evening";
      } else if (hour < 8) {
        timeOfDay = "dawn";
      } else {
        timeOfDay = "day";
      }
    } else {
      timeOfDay = isDayFlag ? "day" : "night";
    }

    if (/thunder|storm|雷/.test(text)) {
      weatherMode = "storm";
      targetSky = skyPresets.storm;
      windX = 2.5;
      createRain(1.3);
      createCloudLayer();
      stars = [];
    } else if (/rain|drizzle|阵雨|雨/.test(text)) {
      weatherMode = "rain";
      targetSky = skyPresets.rain;
      windX = 1.5;
      createRain(1.0);
      createCloudLayer();
      stars = [];
    } else if (/snow|sleet|雪/.test(text)) {
      weatherMode = "snow";
      targetSky = skyPresets.snow;
      windX = 0.3;
      createSnow(1.0);
      createCloudLayer();
      stars = [];
    } else if (/cloud|overcast|多云|阴/.test(text)) {
      weatherMode = "cloud";
      targetSky = skyPresets.cloud;
      windX = 0.6;
      createCloudLayer();
      rainDrops = [];
      snowFlakes = [];
      stars = [];
    } else if (timeOfDay === "night") {
      weatherMode = "night";
      targetSky = skyPresets.night;
      windX = 0.1;
      createStars();
      createCloudLayer();
      rainDrops = [];
      snowFlakes = [];
    } else {
      weatherMode = "sun";
      if (timeOfDay === "evening") {
        targetSky = skyPresets.sun_even;
      } else if (timeOfDay === "dawn") {
        targetSky = skyPresets.sun_dawn;
      } else {
        targetSky = skyPresets.sun_day;
      }
      windX = 0.4;
      rainDrops = [];
      snowFlakes = [];
      createCloudLayer();
      stars = [];
    }
  }

  /* ================== Apple SF 风格天气图标（SVG） ================== */
  var iconWrapper = document.getElementById("iconWrapper");

  function setWeatherIcon() {
    var svg = "";

    if (weatherMode === "sun") {
      if (timeOfDay === "dawn" || timeOfDay === "evening") {
        svg = sunCloudSvg();
      } else {
        svg = sunSvg();
      }
    } else if (weatherMode === "cloud") {
      if (timeOfDay === "night") {
        svg = moonCloudSvg();
      } else {
        svg = cloudSvg();
      }
    } else if (weatherMode === "rain") {
      if (timeOfDay === "night") {
        svg = moonRainSvg();
      } else {
        svg = cloudRainSvg();
      }
    } else if (weatherMode === "storm") {
      svg = cloudBoltRainSvg();
    } else if (weatherMode === "snow") {
      svg = cloudSnowSvg();
    } else if (weatherMode === "night") {
      svg = moonStarsSvg();
    } else {
      svg = sunSvg();
    }

    iconWrapper.innerHTML = svg;
  }

  function sunSvg() {
    return (
      '<svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">' +
        '<defs>' +
          '<radialGradient id="sunCore" cx="0" cy="0" r="1" gradientUnits="userSpaceOnUse" gradientTransform="translate(32 32) rotate(90) scale(18 18)">' +
            '<stop stop-color="#FFF9D4"/>' +
            '<stop offset="1" stop-color="#FFE58F"/>' +
          '</radialGradient>' +
        '</defs>' +
        '<circle cx="32" cy="32" r="18" fill="url(#sunCore)"/>' +
        '<g stroke="#FFE9A9" stroke-width="3" stroke-linecap="round" opacity="0.9">' +
          '<line x1="32" y1="8"  x2="32" y2="2"/>' +
          '<line x1="32" y1="62" x2="32" y2="56"/>' +
          '<line x1="8"  y1="32" x2="2"  y2="32"/>' +
          '<line x1="62" y1="32" x2="56" y2="32"/>' +
          '<line x1="13" y1="13" x2="8"  y2="8"/>' +
          '<line x1="51" y1="51" x2="56" y2="56"/>' +
          '<line x1="13" y1="51" x2="8"  y2="56"/>' +
          '<line x1="51" y1="13" x2="56" y2="8"/>' +
        '</g>' +
      '</svg>'
    );
  }

  function sunCloudSvg() {
    return (
      '<svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">' +
        '<defs>' +
          '<radialGradient id="sunCore2" cx="0" cy="0" r="1" gradientUnits="userSpaceOnUse" gradientTransform="translate(22 20) rotate(90) scale(12 12)">' +
            '<stop stop-color="#FFF9D4"/>' +
            '<stop offset="1" stop-color="#FFE58F"/>' +
          '</radialGradient>' +
        '</defs>' +
        '<circle cx="22" cy="20" r="12" fill="url(#sunCore2)" opacity="0.95"/>' +
        '<path d="M21 40c0-5.5 4.5-10 10-10 4.1 0 7.7 2.4 9.2 6 3.5-.2 6.8 2.4 7.1 6 0 0.2 0 .4 0 .6-0.2 4-3.5 7.1-7.6 7.1H27c-5.2 0-9.3-4.2-9.3-9.3 0-3 1.4-5.7 3.8-7.4C21.1 35.3 21 37.6 21 40Z" fill="white" fill-opacity="0.96"/>' +
      '</svg>'
    );
  }

  function cloudSvg() {
    return (
      '<svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">' +
        '<path d="M23 28c1.3-6 6.6-10.5 13-10.5 7.2 0 13 5.8 13 13 4 0.4 7 3.9 7 8 0 4.4-3.6 8-8 8H23c-5.5 0-10-4.5-10-10 0-5 3.7-9.1 8.4-9.9C21.9 26 22.4 27 23 28Z" fill="white" fill-opacity="0.96"/>' +
      '</svg>'
    );
  }

  function moonSvgBase() {
    return (
      '<path d="M41 14c-2 8.5-1.3 14.9 2.1 20.3C47 40 52.5 44 59 46.5 56.2 50.3 51.6 52.7 46.5 52.7 36.6 52.7 28.5 44.6 28.5 34.7 28.5 25.7 34.1 18.3 41 14Z" fill="rgba(236,241,255,0.95)"/>'
    );
  }

  function moonCloudSvg() {
    return (
      '<svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">' +
        moonSvgBase() +
        '<path d="M20 36c1.3-5.5 6-9.5 11.7-9.5 6.6 0 12 5.1 12.3 11.7 3.5 0.1 6.3 3 6.3 6.5 0 3.6-2.9 6.5-6.5 6.5H24c-4.9 0-9-4-9-9 0-4.4 3.1-8.1 7-8.9Z" fill="white" fill-opacity="0.96"/>' +
      '</svg>'
    );
  }

  function moonStarsSvg() {
    return (
      '<svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">' +
        moonSvgBase() +
        '<circle cx="18" cy="16" r="2" fill="#FFE9A9"/>' +
        '<circle cx="14" cy="24" r="1.6" fill="#FFE9A9"/>' +
        '<circle cx="24" cy="20" r="1.8" fill="#FFE9A9"/>' +
      '</svg>'
    );
  }

  function moonRainSvg() {
    return (
      '<svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">' +
        moonSvgBase() +
        '<path d="M22 35c1.3-5.2 5.9-9.1 11.4-9.1 6.4 0 11.6 5.1 11.6 11.6 3.4 0.1 6.1 2.9 6.1 6.4 0 3.5-2.8 6.4-6.4 6.4H26.3C21.5 50.3 18 46 18 41.5c0-3.9 2.7-7.2 6.1-8.1Z" fill="white" fill-opacity="0.96"/>' +
        '<g stroke="#B9D8FF" stroke-width="2.3" stroke-linecap="round">' +
          '<line x1="26" y1="52" x2="24" y2="58"/>' +
          '<line x1="34" y1="52" x2="32" y2="58"/>' +
          '<line x1="42" y1="52" x2="40" y2="58"/>' +
        '</g>' +
      '</svg>'
    );
  }

  function cloudRainSvg() {
    return (
      '<svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">' +
        '<path d="M23 26c1.4-6 6.7-10.3 13-10.3 7.3 0 13.2 5.9 13.2 13.2 3.9 0.4 6.9 3.7 6.9 7.7 0 4.3-3.5 7.9-7.9 7.9H24c-5.6 0-10.2-4.6-10.2-10.2 0-5 3.6-9.1 8.3-9.9 0.3-1.1 0.6-1.9 0.9-2.4Z" fill="white" fill-opacity="0.96"/>' +
        '<g stroke="#B9D8FF" stroke-width="2.3" stroke-linecap="round">' +
          '<line x1="24" y1="48" x2="22" y2="54"/>' +
          '<line x1="32" y1="48" x2="30" y2="54"/>' +
          '<line x1="40" y1="48" x2="38" y2="54"/>' +
          '<line x1="48" y1="48" x2="46" y2="54"/>' +
        '</g>' +
      '</svg>'
    );
  }

  function cloudBoltRainSvg() {
    return (
      '<svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">' +
        '<path d="M23 26c1.4-6 6.7-10.3 13-10.3 7.3 0 13.2 5.9 13.2 13.2 3.9 0.4 6.9 3.7 6.9 7.7 0 4.3-3.5 7.9-7.9 7.9H24c-5.6 0-10.2-4.6-10.2-10.2 0-5 3.6-9.1 8.3-9.9 0.3-1.1 0.6-1.9 0.9-2.4Z" fill="white" fill-opacity="0.96"/>' +
        '<path d="M30 50l4-8h-4l4-8" stroke="#FFD36B" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round"/>' +
        '<g stroke="#B9D8FF" stroke-width="2.3" stroke-linecap="round">' +
          '<line x1="44" y1="48" x2="42" y2="54"/>' +
        '</g>' +
      '</svg>'
    );
  }

  function cloudSnowSvg() {
    return (
      '<svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">' +
        '<path d="M23 26c1.4-6 6.7-10.3 13-10.3 7.3 0 13.2 5.9 13.2 13.2 3.9 0.4 6.9 3.7 6.9 7.7 0 4.3-3.5 7.9-7.9 7.9H24c-5.6 0-10.2-4.6-10.2-10.2 0-5 3.6-9.1 8.3-9.9 0.3-1.1 0.6-1.9 0.9-2.4Z" fill="white" fill-opacity="0.96"/>' +
        '<g fill="#E5F2FF">' +
          '<circle cx="26" cy="50" r="2"/>' +
          '<circle cx="34" cy="52" r="2"/>' +
          '<circle cx="42" cy="50" r="2"/>' +
        '</g>' +
      '</svg>'
    );
  }

  /* ================== WeatherAPI + UI ================== */

  var API_KEY = "0871934c91a1479984b40316250912";

  var cityEl     = document.getElementById("city");
  var timeEl     = document.getElementById("localtime");
  var tempEl     = document.getElementById("temp");
  var condEl     = document.getElementById("condition");
  var hiLoEl     = document.getElementById("hiLo");
  var feelsEl    = document.getElementById("feelsLike");
  var updatedEl  = document.getElementById("updated");

  var searchInput = document.getElementById("search");
  var searchBtn   = document.getElementById("searchBtn");
  var locBtn      = document.getElementById("locBtn");

  searchBtn.addEventListener("click", function () {
    var val = searchInput.value.trim();
    if (!val) return;
    fetchWeatherByQuery(val);
  });

  searchInput.addEventListener("keydown", function (e) {
    if (e.key === "Enter") {
      searchBtn.click();
    }
  });

  locBtn.addEventListener("click", autoLocate);

  function fetchWeatherByQuery(q) {
    var url =
      "https://api.weatherapi.com/v1/current.json?key=" +
      API_KEY +
      "&q=" +
      encodeURIComponent(q) +
      "&aqi=no";

    fetch(url)
      .then(function (res) { return res.json(); })
      .then(function (data) {
        if (data.error) {
          throw new Error(data.error.message || "API Error");
        }
        updateUI(data);
      })
      .catch(function (e) {
        alert("获取天气失败，请检查城市名或网络连接");
        console.error(e);
      });
  }

  function updateUI(data) {
    var loc = data.location;
    var c   = data.current;

    cityEl.textContent = loc.name + ", " + (loc.region || loc.country);
    timeEl.textContent = "当地时间：" + loc.localtime;
    tempEl.textContent = Math.round(c.temp_c) + "°";
    condEl.textContent = c.condition.text;

    var hi = Math.round(c.temp_c + 2);
    var lo = Math.round(c.temp_c - 2);
    hiLoEl.textContent = "最高 " + hi + "° · 最低 " + lo + "°";

    feelsEl.textContent = "体感：" + Math.round(c.feelslike_c) + "°";

    var now = new Date();
    updatedEl.textContent = "上次更新：" + now.toLocaleTimeString();

    setWeatherVisual(c.condition.text, loc.localtime, c.is_day === 1);
    setWeatherIcon();
  }

  function autoLocate() {
    if (!navigator.geolocation) {
      fetchWeatherByQuery("Sydney");
      return;
    }
    navigator.geolocation.getCurrentPosition(
      function (pos) {
        var q = pos.coords.latitude + "," + pos.coords.longitude;
        fetchWeatherByQuery(q);
      },
      function (err) {
        console.warn("定位失败，使用默认城市", err);
        fetchWeatherByQuery("Sydney");
      }
    );
  }

  // 初始加载
  autoLocate();
</script>

</body>
</html>
