<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>æç®€å¤©æ°” Â· é¦–é¡µ</title>
<style>
  /* ========== Reset & åŸºç¡€ ========== */
  :root{
    --card-bg: rgba(255,255,255,0.06);
    --glass-border: rgba(255,255,255,0.08);
    --text: rgba(255,255,255,0.95);
    --muted: rgba(255,255,255,0.75);
    --accent: rgba(255,255,255,0.85);
    --shadow: 0 8px 30px rgba(0,0,0,0.45);
    --radius: 16px;
    font-family: Inter, "Helvetica Neue", Arial, sans-serif;
  }
  html,body{height:100%;margin:0;background:#111;overflow:hidden}
  *{box-sizing:border-box}
  /* canvas è¦†ç›–èƒŒæ™¯ */
  #bg-canvas{position:fixed;inset:0;z-index:0;display:block}
  /* æ¸å˜è¦†ç›–å±‚ï¼ˆç”¨äºæŸ”å’Œè½¬åœºï¼‰ */
  .bg-overlay{position:fixed;inset:0;z-index:1;pointer-events:none;transition:background 900ms ease}
  /* ä¸»å®¹å™¨ */
  .wrap{position:relative;z-index:2;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px;}
  .card{
    width:min(920px,96vw);
    max-width:1100px;
    display:grid;
    grid-template-columns: 1fr 360px;
    gap:24px;
    background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
    border-radius:var(--radius);
    border:1px solid var(--glass-border);
    padding:26px;
    box-shadow:var(--shadow);
    backdrop-filter: blur(8px) saturate(1.05);
  }

  /* å“åº”å¼æ”¹æˆå•åˆ— */
  @media (max-width:900px){
    .card{grid-template-columns: 1fr; padding:18px}
  }

  /* å·¦ä¾§ ä¸»ä¿¡æ¯ */
  .main {
    display:flex;flex-direction:column;justify-content:space-between;
  }
  .top{
    display:flex;align-items:center;gap:16px;
  }
  .city{
    font-size:20px;color:var(--text);font-weight:700;
  }
  .sub{color:var(--muted);font-size:13px;margin-top:4px}

  .temp-row{
    display:flex;align-items:center;gap:18px;margin-top:18px;
  }
  .temp{
    font-size:72px;font-weight:700;color:var(--text);line-height:1;
  }
  .cond{
    display:flex;flex-direction:column;
  }
  .cond .txt{font-size:18px;color:var(--muted);margin-bottom:6px}
  .small{
    color:var(--muted);font-size:14px;
  }

  /* å³ä¾§ æ§ä»¶ */
  .panel{
    padding:18px;border-left:1px dashed rgba(255,255,255,0.04);
    display:flex;flex-direction:column;gap:10px;align-items:stretch;
  }
  @media (max-width:900px){ .panel{border-left:0;border-top:1px dashed rgba(255,255,255,0.04)} }

  .search{
    display:flex;gap:8px;
  }
  .search input{
    flex:1;padding:12px 14px;border-radius:10px;border:0;background:rgba(255,255,255,0.03);color:var(--text);outline:none;font-size:14px;
  }
  .search button{
    padding:10px 14px;border-radius:10px;border:0;background:linear-gradient(90deg,#ffffff22,#ffffff11);color:var(--accent);cursor:pointer;font-weight:600;
  }

  .stats{
    display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:14px;
  }
  .stat{
    padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);font-size:13px;color:var(--muted);
  }
  .stat strong{display:block;color:var(--text);font-size:15px;margin-bottom:6px}

  /* å°å‹å›¾æ ‡å ä½ */
  .icon{
    width:84px;height:84px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));display:flex;align-items:center;justify-content:center;
    font-size:34px;color:var(--accent)
  }

  /* footer å°å­— */
  .credits{margin-top:10px;font-size:12px;color:rgba(255,255,255,0.6)}

  /* è¿‡æ¸¡åŠ¨ç”»ï¼ˆå¤©æ°”ç±»å‹è½»å¾®æµ®åŠ¨ï¼‰ */
  .card {transition: transform 800ms cubic-bezier(.2,.9,.3,1)}
  .morn { transform: translateY(-6px) }
  .evening { transform: translateY(6px) }

  /* æç®€ loading åœ†ç‚¹ */
  .dot {width:10px;height:10px;border-radius:50%;background:rgba(255,255,255,0.12);display:inline-block;margin:0 6px;animation:blink 1.2s infinite;}
  @keyframes blink {0%{opacity:0.2}50%{opacity:1}100%{opacity:0.2}}

  /* å°å±ä¸‹æŠŠæ¸©åº¦å­—ä½“å˜å° */
  @media (max-width:420px){ .temp{font-size:48px} .icon{width:68px;height:68px;font-size:28px} }
</style>
</head>
<body>
<canvas id="bg-canvas"></canvas>
<div class="bg-overlay" id="bg-overlay"></div>

<div class="wrap">
  <div class="card" id="card">
    <!-- LEFT -->
    <div class="main">
      <div>
        <div class="top">
          <div>
            <div class="city" id="city">æ­£åœ¨å®šä½ <span class="dot"></span></div>
            <div class="sub" id="localtime">â€”</div>
          </div>
          <div style="margin-left:auto;text-align:right">
            <div class="icon" id="weather-icon">â˜ï¸</div>
          </div>
        </div>

        <div class="temp-row">
          <div class="temp" id="temp">--Â°</div>
          <div class="cond">
            <div class="txt" id="condition">åŠ è½½ä¸­â€¦</div>
            <div class="small" id="feels">ä½“æ„Ÿï¼šâ€”</div>
          </div>
        </div>
      </div>

      <div style="margin-top:12px">
        <div class="small" id="summary">ä»Šæ—¥æ‘˜è¦ï¼šâ€”</div>
        <div class="credits" id="credits">æ•°æ®æ¥æºï¼šWeatherAPI Â· æç®€è‰ºæœ¯é£</div>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="panel">
      <div style="font-size:13px;color:var(--muted);font-weight:600">æœç´¢åŸå¸‚ / å®šä½</div>
      <div class="search">
        <input id="search-input" placeholder="ä¾‹å¦‚ï¼šSydney æˆ–è¾“å…¥ lat,lon (e.g. -33.86,151.20)">
        <button id="search-btn">æœç´¢</button>
      </div>

      <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
        <button id="loc-btn" style="flex:1;padding:10px;border-radius:10px;border:0;background:#ffffff10;color:var(--accent);cursor:pointer">ä½¿ç”¨æµè§ˆå™¨å®šä½</button>
        <button id="refresh-btn" title="åˆ·æ–°" style="width:46px;border-radius:10px;border:0;background:#ffffff08;color:var(--accent);cursor:pointer">âŸ³</button>
      </div>

      <div class="stats" id="stats">
        <div class="stat"><strong id="high">â€”</strong>ä»Šæ—¥æœ€é«˜</div>
        <div class="stat"><strong id="low">â€”</strong>ä»Šæ—¥æœ€ä½</div>
        <div class="stat"><strong id="wind">â€”</strong>é£é€Ÿ (km/h)</div>
        <div class="stat"><strong id="humidity">â€”</strong>æ¹¿åº¦ %</div>
        <div class="stat"><strong id="uv">â€”</strong>ç´«å¤–çº¿</div>
        <div class="stat"><strong id="precip">â€”</strong>é™æ°´ mm</div>
      </div>

      <div style="margin-top:auto;font-size:12px;color:var(--muted);">
        å°è´´å£«ï¼šâ‡¢ æœç´¢ç²¾ç¡®åŸå¸‚æˆ–ç”¨ GPS å®šä½ä»¥è·å¾—æœ€ä½³ä½“éªŒ
      </div>
    </div>
  </div>
</div>

<script>
/* ================== é…ç½®åŒº ================== */
const API_KEY = "0871934c91a1479984b40316250912"; // â† å¦‚éœ€æ¢ key åœ¨è¿™é‡Œæ›¿æ¢
const DEFAULT_CITY = "Adelaide"; // å®šä½å¤±è´¥/é»˜è®¤åŸå¸‚
/* =========================================== */

const canvas = document.getElementById('bg-canvas');
const overlay = document.getElementById('bg-overlay');
const ctx = canvas.getContext('2d');
let W = canvas.width = innerWidth;
let H = canvas.height = innerHeight;
let particles = [];
let mode = "clear"; // clear, cloudy, rain, storm, snow, fog, night, sunset

// UI å…ƒç´ 
const cityEl = document.getElementById('city');
const localtimeEl = document.getElementById('localtime');
const tempEl = document.getElementById('temp');
const condEl = document.getElementById('condition');
const feelsEl = document.getElementById('feels');
const iconEl = document.getElementById('weather-icon');
const summaryEl = document.getElementById('summary');
const highEl = document.getElementById('high');
const lowEl = document.getElementById('low');
const windEl = document.getElementById('wind');
const humidityEl = document.getElementById('humidity');
const uvEl = document.getElementById('uv');
const precipEl = document.getElementById('precip');
const card = document.getElementById('card');

const searchInput = document.getElementById('search-input');
const searchBtn = document.getElementById('search-btn');
const locBtn = document.getElementById('loc-btn');
const refreshBtn = document.getElementById('refresh-btn');

searchBtn.addEventListener('click', ()=> queryCity(searchInput.value || DEFAULT_CITY));
searchInput.addEventListener('keydown', e => { if (e.key === 'Enter') searchBtn.click();});
locBtn.addEventListener('click', ()=> locateAndLoad());
refreshBtn.addEventListener('click', ()=> {
  if (lastQuery) queryCity(lastQuery);
});

let lastQuery = null;

/* ------------ Helpers ------------ */
function resize(){
  W = canvas.width = innerWidth;
  H = canvas.height = innerHeight;
}
addEventListener('resize', resize);

function rand(min,max){ return Math.random()*(max-min)+min }

/* ========== ç²’å­ç³»ç»Ÿï¼ˆæç®€æŠ½è±¡ï¼‰ ========== */
class Particle {
  constructor(x,y,vx,vy,size,color,life,shape='circle'){ Object.assign(this,{x,y,vx,vy,size,color,life,shape}); }
  step(dt){
    this.x += this.vx*dt; this.y += this.vy*dt; this.life -= dt;
    // wrap horizontal
    if (this.x < -50) this.x = W+50;
    if (this.x > W+50) this.x = -50;
  }
  draw(ctx){
    ctx.globalAlpha = Math.max(0, Math.min(1,this.life));
    ctx.fillStyle = this.color;
    if (this.shape==='circle') ctx.beginPath(), ctx.arc(this.x,this.y,this.size,0,Math.PI*2), ctx.fill();
    else ctx.fillRect(this.x,this.y,this.size*2,this.size);
    ctx.globalAlpha = 1;
  }
}

let lastT = 0;
function animate(t){
  const dt = Math.min(0.04, (t-lastT)/1000);
  lastT = t;
  ctx.clearRect(0,0,W,H);

  // èƒŒæ™¯æŸ”å’Œæ¸å˜ï¼ˆoverlay æ ·å¼ï¼‰
  // ç²’å­ä¸è§†è§‰
  for (let p of particles){ p.step(dt); p.draw(ctx); }
  // subtle vignette
  const g = ctx.createLinearGradient(0,0,0,H);
  g.addColorStop(0,'rgba(0,0,0,0.0)');
  g.addColorStop(1,'rgba(0,0,0,0.18)');
  ctx.fillStyle = g;
  ctx.fillRect(0,0,W,H);

  requestAnimationFrame(animate);
}
requestAnimationFrame(animate);

/* ========== å¤©æ°”æ¨¡å¼ç”Ÿæˆå™¨ï¼ˆæŠ½è±¡åŠ¨ç”»å‚æ•°ï¼‰ ========== */
function setMode(m){
  mode = m;
  particles.length = 0;
  // overlay gradient sets via CSS background
  overlay.style.transition = "background 900ms ease";
  switch(mode){
    case 'clear':
      overlay.style.background = "linear-gradient(180deg, rgba(255,200,120,0.06), rgba(30,80,180,0.18))";
      createSunParticles(); card.classList.remove('evening'); card.classList.add('morn'); break;
    case 'cloudy':
      overlay.style.background = "linear-gradient(180deg, rgba(200,210,220,0.06), rgba(100,110,130,0.12))";
      createCloudParticles(); card.classList.remove('morn'); card.classList.remove('evening'); break;
    case 'rain':
      overlay.style.background = "linear-gradient(180deg, rgba(90,100,120,0.08), rgba(40,50,70,0.14))";
      createRainParticles(130); card.classList.remove('morn'); card.classList.add('evening'); break;
    case 'storm':
      overlay.style.background = "linear-gradient(180deg, rgba(50,60,80,0.08), rgba(10,10,20,0.16))";
      createRainParticles(200); startLightning(); card.classList.add('evening'); break;
    case 'snow':
      overlay.style.background = "linear-gradient(180deg, rgba(230,240,250,0.06), rgba(180,200,220,0.08))";
      createSnowParticles(80); card.classList.remove('evening'); card.classList.add('morn'); break;
    case 'fog':
      overlay.style.background = "linear-gradient(180deg, rgba(220,220,220,0.06), rgba(180,180,180,0.06))";
      createFogParticles(80); card.classList.remove('morn'); card.classList.remove('evening'); break;
    case 'night':
      overlay.style.background = "linear-gradient(180deg, rgba(10,10,30,0.15), rgba(2,6,30,0.55))";
      createStars(); card.classList.add('evening'); break;
    case 'sunset':
      overlay.style.background = "linear-gradient(180deg, rgba(255,140,90,0.10), rgba(40,18,70,0.16))";
      createSunParticles(); card.classList.add('morn'); break;
    default:
      overlay.style.background = "linear-gradient(180deg, rgba(255,200,120,0.03), rgba(30,80,180,0.08))";
      createCloudParticles();
  }
}

/* particle presets */
function createSunParticles(){
  for (let i=0;i<60;i++){
    particles.push(new Particle(rand(0,W), rand(0,H*0.6), rand(-6,6), rand(-6,6), rand(0.6,2.6), 'rgba(255,220,180,0.08)', rand(2,8)));
  }
}
function createCloudParticles(){
  for (let i=0;i<45;i++){
    particles.push(new Particle(rand(0,W), rand(H*0.05,H*0.6), rand(-6,-0.5), rand(-0.2,0.2), rand(18,46), 'rgba(255,255,255,0.04)', 10,'rect'));
  }
}
function createRainParticles(count=120){
  for (let i=0;i<count;i++){
    particles.push(new Particle(rand(0,W), rand(-H, H), rand(-10,10), rand(800,1200), rand(0.6,1.8), 'rgba(255,255,255,0.08)', 2,'rect'));
  }
}
function createSnowParticles(count=60){
  for (let i=0;i<count;i++){
    particles.push(new Particle(rand(0,W), rand(-H, H), rand(-10,10), rand(30,90), rand(1.6,4.8), 'rgba(255,255,255,0.92)', 8,'circle'));
  }
}
function createFogParticles(count=60){
  for (let i=0;i<count;i++){
    particles.push(new Particle(rand(0,W), rand(0,H), rand(-3,3), rand(-1,1), rand(40,140), 'rgba(255,255,255,0.03)', 8,'rect'));
  }
}
function createStars(){
  for (let i=0;i<140;i++){
    particles.push(new Particle(rand(0,W), rand(0,H*0.7), rand(-0.6,0.6), rand(0,0.4), rand(0.6,1.8), 'rgba(255,255,255,'+Math.random()*0.9+')', rand(4,10),'circle'));
  }
}

/* lightning */
let lightningTimer = null;
function startLightning(){
  if (lightningTimer) clearInterval(lightningTimer);
  lightningTimer = setInterval(()=> {
    // éšæœºçŸ­æš‚é—ªç™½
    overlay.style.transition = 'background 160ms ease';
    overlay.style.filter = 'brightness(1.6) saturate(1.3)';
    setTimeout(()=> overlay.style.filter = '', 140);
  }, rand(3000,12000));
}
function stopLightning(){
  if (lightningTimer) { clearInterval(lightningTimer); lightningTimer = null; }
}

/* ========== WeatherAPI è¯·æ±‚ & é€»è¾‘ ========== */
async function fetchWeather(q){
  // ä½¿ç”¨ forecast 1 å¤©æ‹¿åˆ° max/min
  const url = `https://api.weatherapi.com/v1/forecast.json?key=${API_KEY}&q=${encodeURIComponent(q)}&days=1&aqi=no&alerts=no`;
  const res = await fetch(url);
  if (!res.ok) throw new Error('ç½‘ç»œæˆ–åŸå¸‚åé”™è¯¯');
  const data = await res.json();
  return data;
}

function mapConditionToMode(text, is_night=false){
  text = text.toLowerCase();
  if (text.match(/rain|shower|drizzle|é›·é›¨|é›¨/)) {
    if (text.match(/thunder|storm|é›·/)) return 'storm';
    return 'rain';
  }
  if (text.match(/snow|sleet|å†°é›¹|é›ª/)) return 'snow';
  if (text.match(/mist|fog|haze|é›¾|éœ¾/)) return 'fog';
  if (is_night || text.match(/clear night|å¤œ/)) return 'night';
  if (text.match(/cloud|overcast|å¤šäº‘|é˜´/)) return 'cloudy';
  if (text.match(/sun|clear|æ™´/)) return 'clear';
  if (text.match(/sunset|dusk|é»„æ˜|æ™š/)) return 'sunset';
  return 'clear';
}

function updateUIFromData(data){
  const loc = data.location;
  const cur = data.current;
  const f = data.forecast?.forecastday?.[0]?.day;

  cityEl.textContent = `${loc.name}, ${loc.country}`;
  localtimeEl.textContent = `æœ¬åœ°æ—¶é—´: ${loc.localtime}`;
  tempEl.textContent = `${Math.round(cur.temp_c)}Â°C`;
  condEl.textContent = cur.condition.text;
  feelsEl.textContent = `ä½“æ„Ÿ ${Math.round(cur.feelslike_c)}Â°C`;
  iconEl.textContent = ''; // ç”¨æç®€å›¾æ ‡æ›¿æ¢
  // Small ascii/icon mapping (æç®€)
  const ic = (cur.condition.text||'').toLowerCase();
  if (ic.match(/rain|é›¨/)) iconEl.textContent = 'ğŸŒ§';
  else if (ic.match(/cloud|å¤šäº‘|é˜´/)) iconEl.textContent = 'â˜ï¸';
  else if (ic.match(/snow|é›ª/)) iconEl.textContent = 'â„ï¸';
  else if (ic.match(/mist|é›¾/)) iconEl.textContent = 'ğŸŒ«ï¸';
  else if (ic.match(/clear|æ™´/)) {
    // day/night check
    const isNight = loc.localtime.includes(' ') ? (new Date(loc.localtime).getHours() < 6 || new Date(loc.localtime).getHours() >= 19) : false;
    iconEl.textContent = isNight ? 'ğŸŒ™' : 'â˜€ï¸';
  } else iconEl.textContent = 'ğŸŒ¤ï¸';

  // summary
  summaryEl.textContent = `æ„Ÿå—ï¼š${cur.condition.text} Â· å®æ—¶ ${cur.temp_c}Â°C`;

  highEl.textContent = f ? `${Math.round(f.maxtemp_c)}Â°C` : 'â€”';
  lowEl.textContent = f ? `${Math.round(f.mintemp_c)}Â°C` : 'â€”';
  windEl.textContent = `${cur.wind_kph}`;
  humidityEl.textContent = `${cur.humidity}`;
  uvEl.textContent = `${cur.uv}`;
  precipEl.textContent = `${cur.precip_mm}`;

  // map to mode
  const isNight = loc.localtime ? (new Date(loc.localtime).getHours() < 6 || new Date(loc.localtime).getHours() >= 19) : false;
  const modeName = mapConditionToMode(cur.condition.text, isNight);
  setMode(modeName);
  // lightning control
  if (modeName !== 'storm') stopLightning();

  // nice subtle transform for card
  card.classList.remove('morn','evening');
  if (modeName==='clear' || modeName==='sunset') card.classList.add('morn');
  if (modeName==='storm' || modeName==='night' || modeName==='rain') card.classList.add('evening');
}

/* ========== å®šä½ & æŸ¥è¯¢ ========== */
async function queryCity(q){
  if (!q) q = DEFAULT_CITY;
  lastQuery = q;
  cityEl.textContent = 'åŠ è½½ä¸­â€¦';
  try{
    const data = await fetchWeather(q);
    updateUIFromData(data);
  }catch(err){
    alert('æŸ¥è¯¢å¤±è´¥ï¼Œè¯·æ£€æŸ¥åŸå¸‚åæˆ–ç¨åé‡è¯•');
    console.error(err);
  }
}

async function locateAndLoad(){
  cityEl.textContent = 'å®šä½ä¸­â€¦';
  // æµè§ˆå™¨å®šä½ä¼˜å…ˆ
  if (navigator.geolocation){
    navigator.geolocation.getCurrentPosition(async pos => {
      const lat = pos.coords.latitude.toFixed(6);
      const lon = pos.coords.longitude.toFixed(6);
      await queryCity(`${lat},${lon}`);
    }, async err => {
      // å›é€€åˆ° IP å®šä½
      try{
        const r = await fetch('https://ipapi.co/json/');
        const j = await r.json();
        await queryCity(`${j.city}`);
      }catch(e){
        await queryCity(DEFAULT_CITY);
      }
    }, {timeout:8000});
  } else {
    await queryCity(DEFAULT_CITY);
  }
}

/* åˆå§‹åŒ– */
locateAndLoad();

/* å°æ”¹è¿›ï¼šè‡ªåŠ¨åˆ·æ–°æ¯ 10 åˆ†é’Ÿ */
setInterval(()=> { if (lastQuery) queryCity(lastQuery); }, 10*60*1000);

/* ç»“æŸ */
</script>
</body>
</html>
